"use strict";function ajaxRequest(e){var n=new Promise(function(n,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.send(),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var e=JSON.parse(a.responseText);n(e)}else 4==a.readyState&&200!==a.status&&t(e)}});return n}function failCallback(){document.getElementById("venues-error-message").className="visible"}function getSushiPlacesAndShowPlaces(e){fillInPlacesArray(e.response.venues,"sushi"),viewModel.initializeMarkers()}function getCoffeePlaces(e){return fillInPlacesArray(e.response.venues,"coffee"),ajaxRequest(SUSHI_IN_MTV_URL)}function fillInPlacesArray(e,n){for(var t in e)places.push({name:e[t].name,address:createAddressString(e[t].location),lat:e[t].location.lat,lng:e[t].location.lng,id:e[t].id,iconType:n})}function createAddressString(e){var n=e.address+" "+e.city+", "+e.state+" "+e.postalCode;return n}var CLIENT_ID="O4L3T0YIVRWVHCWIQ1Y1UHUXUDRBQ3S4AXKT4ZIQTSIKQMNN",CLIENT_SECRET="5KVONUBGB0YJZJFMTAIXKGCMRB15KEVAGRY2YWMCCZF03EXC",COFFEE_IN_MTV_URL="https://api.foursquare.com/v2/venues/search?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20130815&near=Mountain View, CA&query=coffee",SUSHI_IN_MTV_URL="https://api.foursquare.com/v2/venues/search?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20130815&near=Mountain View, CA&query=sushi",places=[],icons={sushi:{icon:"dist/images/sushi.png"},coffee:{icon:"dist/images/coffee.png"}},Marker=function(e){var n=this;n.name=e.name,n.address=e.address,n.lat=e.lat,n.lng=e.lng,n.iconType=e.iconType,n.id=e.id,n.infoWindowContent=null,n.mapMarker=null,n.activate=null,n.setInfoWindowContent=function(e){n.infoWindowContent=e},n.setMapMarker=function(e){n.mapMarker=e},n.setActivate=function(e){n.activate=e}},ViewModel=function(){function e(e){return function(){n(e)}}function n(e){if(e.mapMarker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.mapMarker.setAnimation(null)},1400),null!==e.infoWindowContent)d.setContent(e.infoWindowContent),d.open(r,e.mapMarker);else{var n=e.lat+","+e.lng,o="https://maps.googleapis.com/maps/api/streetview?size=100x100&location="+n,i=("https://api.foursquare.com/v2/venues/search?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20130815&query="+e.name+"&intent=match&ll="+n,"https://api.foursquare.com/v2/venues/"+e.id+"?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20130815"),s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==s.readyState&&200==s.status){var n=JSON.parse(s.responseText);t(e,o,n.response.venue)}else 4==s.readyState&&200!==s.status&&a(e)},s.open("GET",i,!0),s.send()}}function t(e,n,t){var a=e.address,o="Rating: "+t.rating+"/10",i=t.canonicalUrl,s=document.createElement("div");s.setAttribute("class","info-window-container");var l=document.getElementById("inforWindowTemplate").content;l.getElementById("info-image").src=n,l.getElementById("venue-name").innerHTML=e.name,l.getElementById("venue-address").innerHTML=a,l.getElementById("venue-rating").innerHTML=o,l.getElementById("details-link").href=i,t.hasOwnProperty("phrases")&&(l.getElementById("review").innerHTML=t.phrases[0].sample.text);var c=document.importNode(l,!0);s.appendChild(c),e.setInfoWindowContent(s),d.setContent(s),d.open(r,e.mapMarker)}function a(e){var n=new google.maps.InfoWindow({content:"<div class='error-message'>Failed to load venue details from foursquare server</div>"});n.open(r,e.mapMarker)}function o(e){for(var n=l.filteredMarkers().length,t=0;n>t;t++)l.filteredMarkers()[t].mapMarker.setMap(e)}var r,i=37.4006792,s=-122.068216,l=this;l.markers=ko.observableArray([]),l.filteredMarkers=ko.observableArray([]);var c;l.query=ko.observable("");var d;l.initializeMap=function(){var e=document.getElementById("map-canvas"),n={center:new google.maps.LatLng(i,s),zoom:13,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_CENTER},scaleControl:!0};r=new google.maps.Map(e,n);var t=new google.maps.LatLng(37.369158,-122.115449),a=new google.maps.LatLng(37.445802,-121.9801157),o=new google.maps.LatLngBounds(t,a);r.fitBounds(o),window.addEventListener("resize",function(e){r.fitBounds(o)}),d=new google.maps.InfoWindow},l.initializeMarkers=function(){places.forEach(function(e){l.markers.push(new Marker(e))}),c=l.markers().length;for(var t=0;c>t;t++)l.filteredMarkers.push(l.markers()[t]);for(var t=0;c>t;t++){var a=l.markers()[t],o=new google.maps.Marker({position:new google.maps.LatLng(a.lat,a.lng),map:r,icon:icons[a.iconType].icon});a.setMapMarker(o),a.setActivate(n),o.addListener("click",e(a))}},l.filter=function(){o(null),l.filteredMarkers.removeAll();for(var e,n=0;c>n;n++)e=l.markers()[n],(-1!=e.name.toLowerCase().indexOf(l.query().toLowerCase())||-1!=e.address.toLowerCase().indexOf(l.query().toLowerCase()))&&l.filteredMarkers.push(e);o(r)}};ajaxRequest(COFFEE_IN_MTV_URL).then(getCoffeePlaces,failCallback).then(getSushiPlacesAndShowPlaces,failCallback);var viewModel=new ViewModel;ko.applyBindings(viewModel),viewModel.initializeMap(),viewModel.query.subscribe(function(){viewModel.filter()});